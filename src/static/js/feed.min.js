/*! meavisa - v0.0.2
* http://meavisa.org
* Copyright (c) 2014 ; Licensed  */
requirejs.config({appDir:".",baseUrl:"static/js",paths:{jquery:["//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min","vendor/jquery-2.0.3.min"],bootstrap:["//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.0.0/js/bootstrap.min","vendor/bootstrap-3.0.0.min"],underscore:["//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.5.1/underscore-min","vendor/underscore-1.5.1.min"],backbone:["//cdnjs.cloudflare.com/ajax/libs/backbone.js/1.0.0/backbone-min","vendor/backbone-1.0.0.min"]},shim:{underscore:{exports:"_"},bootstrap:{deps:["jquery"]},backbone:{exports:"Backbone",deps:["underscore","jquery"]}}}),require(["jquery","bootstrap"],function(a){a("a[data-ajax-post-href],button[data-ajax-post-href]").click(function(){var b=this.dataset.ajaxPostHref,c=this.dataset.redirectHref;console.log(this.dataset,b),a.post(b,function(){c?window.location.href=c:window.location.reload()})}),a("form[data-ajax-post-href]").on("submit",function(b){b.preventDefault();var c=this.dataset.ajaxPostHref+"?"+a(this).serialize();console.log(this.dataset,c),a.post(c,function(){window.location.reload()})}),a(function(){if(a("[data-toggle=popover]").popover(),a("[data-toggle=tooltip]").tooltip(),a("[data-toggle=dialog]").xdialog(),"front"===document.body.dataset.page){var b=a("nav.bar"),c=(a("#jumbo").height(),b.outerHeight());a(window).on("scroll ready",function(){a(window).scrollTop()>c?b.addClass("opaque"):b.removeClass("opaque")})}}),function(){a.ajaxPrefilter(function(b,c,d){b.crossDomain||d.setRequestHeader("X-CSRF-Token",a("meta[name='csrf-token']").attr("content"))})}(),function(b){a(".flash-msgs")[0]||a("<div class='flash-msgs'>").prependTo(a("body > section")[0]);for(var c=0;b.warn&&c<b.warn.length;c++)a("<div class='warn'><button type=button class=close data-dismiss=alert aria-hidden=true>&times;</button>"+b.warn[c]+"</div>").hide().appendTo(a(".flash-msgs")).slideDown();for(var c=0;b.info&&c<b.info.length;c++)a("<div class='info'><button type=button class=close data-dismiss=alert aria-hidden=true>&times;</button>"+b.info[c]+"</div>").hide().appendTo(a(".flash-msgs")).slideDown()}(window._flash_msgs)}),function(){for(var a,b=function(){},c=["assert","clear","count","debug","dir","dirxml","error","exception","group","groupCollapsed","groupEnd","info","log","markTimeline","profile","profileEnd","table","time","timeEnd","timeStamp","trace","warn"],d=c.length,e=window.console=window.console||{};d--;)a=c[d],e[a]||(e[a]=b)}(),require(["jquery"],function(a){"strict use";a.fn.sshare=function(b){if(!this.find(".sn-share-btns").length){var c={trigger:"hover",duration:"fast",text:void 0,url:"http://vempraruavem.org"},b=a.extend(a.extend(c,this.data()),b),d={twitter:function(){if(!b.text&&!b.url)throw"No url or text specified";var a="http://twitter.com/share?"+(b.text&&"&text="+encodeURIComponent(b.text))||"url="+encodeURIComponent(b.url);window.open(a,"","width=500,height=350,toolbar=0,menubar=0,location=0","modal=yes")},facebook:function(){if(!b.url)throw"No url or text specified";var a="http://www.facebook.com/sharer.php?u="+encodeURIComponent(b.url);window.open(a,"","width=500,height=350,toolbar=0,menubar=0,location=0","modal=yes")},gplus:function(){if(!b.url)throw"No url or text specified";var a="https://plusone.google.com/_/+1/confirm?hl=pt&url="+encodeURIComponent(b.url);window.open(a,"","width=500,height=350,toolbar=0,menubar=0,location=0","modal=yes")}};this.addClass("sn-share");var e=a('<div class="sn-share-btns"><div class="btn-group"><button class="btn btn-xs btn-info btn-twitter"><i class="fa fa-twitter"></i></button><button class="btn btn-xs btn-info btn-facebook">&nbsp;<i class="fa fa-facebook"></i>&nbsp;</button><button class="btn btn-xs btn-info btn-gplus"><i class="fa fa-google-plus"></i></button></div><div class="arrow"></div></div>');e.find(".btn-twitter").click(d.twitter),e.find(".btn-facebook").click(d.facebook),e.find(".btn-gplus").click(d.gplus),e.appendTo(this),this.click(function(a){return a.stopPropagation(),a.preventDefault(),!1}),b.now===!0?(e.fadeIn(),this.on("click "+("hover"===b.trigger?"mouseenter":""),function(){e.fadeIn(b.duration)})):this.on("click "+("hover"===b.trigger?"mouseenter":""),function(){e.fadeIn(b.duration)}),this.on("mouseleave",function(){e.fadeOut(b.duration)})}},a.fn.xdialog=function(){if(this[0]){var b=this[0].hash||"#"+this[0].dataset.hash,c=a(b),d=!!this.data("hide-url");this.click(function(a){a.preventDefault(),c.addClass("active"),d||history.pushState({},"",b)}),c.find("[data-action=close-dialog]").click(function(a){a.preventDefault(),c.removeClass("active"),d||(location.hash="")})}}}),require(["jquery","backbone","underscore","bootstrap"],function(a,b,c){c.templateSettings={interpolate:/\<\@\=(.+?)\@\>/gim,evaluate:/\<\@([\s\S]+?)\@\>/gim,escape:/\<\@\-(.+?)\@\>/gim};var d=function(){"use strict";var d=b.Model.extend({idAttribute:"hashtag",saveOnChange:!1,defaults:{children:[],description:null},initialize:function(){this.children=new f,this.collection.on("reset",this.loadChildren,this),this.collection.on("checkAll",this.check,this),this.collection.on("uncheckAll",this.uncheck,this)},toggleChecked:function(a){var b=this.get("checked");if(b&&"false"!==b?this.set({checked:!1}):this.set({checked:!0}),a&&void 0!==a.save?a.save===!0:this.saveOnChange){var c=a&&a.callback||function(){};this.save(["checked"],{patch:!0,success:c,error:c})}},check:function(a){if(this.set({checked:!0}),a&&void 0!==a.save?a.save===!0:this.saveOnChange){var b=a&&a.callback||function(){};this.save(["checked"],{patch:!0,success:b,error:b})}},uncheck:function(a){if(this.set({checked:!1}),a&&void 0!==a.save?a.save===!0:this.saveOnChange){var b=a&&a.callback||function(){};this.save(["checked"],{patch:!0,success:b,error:b})}},hasCheckedChild:function(){return c.any(this.children.map(function(a){return a.get("checked")}))},loadChildren:function(){this.children.parseAndReset(this.get("children"))}}),e=b.View.extend({tagName:"li",template:c.template(a("#template-tagview").html()),initialize:function(){this.model.collection.on("reset",this.destroy,this),this.hideChildren=!0,this.childrenView=new g({collection:this.model.children,className:"children"}),this.model.children.on("change",this.childrenChanged,this)},childrenChanged:function(){this.collection!==app.tagList&&(console.log("\n\nchildrenChanged",this),this.render())},destroy:function(){console.log('Removing me view ="(',this),this.remove()},render:function(){return this.childrenView.$el.detach(),this.$el.html(this.template({tag:c.extend(this.model.toJSON(),{hasCheckedChild:this.model.hasCheckedChild()})})),this.hideChildren&&this.childrenView.$el.hide(),this.$el.append(this.childrenView.el),this.$("> .tag .info").popover({content:this.model.get("description"),placement:"bottom",trigger:"hover",container:"body",delay:{show:100,hide:300},title:"<i class='icon-tag'></i> "+this.model.get("hashtag"),html:!0}),this.$("> .tag .info").click(function(a){a.stopPropagation()}),this},events:{"click >.tag":"tgChecked","click >.expand":"tgShowChildren"},tgChecked:function(a){a.preventDefault(),this.model.get("checked")?this.model.children.trigger("uncheckAll"):this.model.children.trigger("checkAll"),this.model.children.trigger("render"),this.model.toggleChecked(),this.render()},tgShowChildren:function(a){a.preventDefault(),this.hideChildren=!this.hideChildren,this.$(">.expand i").toggleClass("fa-angle-down"),this.$(">.expand i").toggleClass("fa-angle-up"),this.childrenView.$el.toggle(),this.childrenView.render()}}),f=b.Collection.extend({model:d,url:"/api/tags",parse:function(a){return c.toArray(a)},parseAndReset:function(a){this.reset(c.toArray(a))},save:function(b){a.post(this.url,{checked:this.getCheckedTags()},b)},getChecked:function(){var a=this.chain().map(function b(a){return[a].concat(a.children.length?a.children.map(b):[])}).flatten().value();return a.filter(function(a){return a.get("checked")===!0})},getCheckedTags:function(){return this.getChecked().map(function(a){return a.get("hashtag")})}}),g=b.View.extend({tagName:"ul",className:"body",_views:[],initialize:function(){this.collection.on("render",this.render,this),this.collection.on("reset",this.addAll,this)},addAll:function(){return this._views=[],this.collection.each(function(a){this._views.push(new e({model:a}))},this),this.render()},render:function(){var a=document.createDocumentFragment();return c.each(this._views,function(b){a.appendChild(b.render().el)},this),this.$el.empty(),this.$el.append(a),this}});return{item:d,list:f,view:e,listView:g}}(),f=function(){"use strict";var d=b.Model.extend({urlRoot:"/api/posts"}),e=b.View.extend({tagName:"li",className:"post",template:c.template(a("#template-postview").html()),initialize:function(){this.model.collection.on("reset",this.destroy,this)},destroy:function(){this.undelegateEvents(),this.$el.removeData().unbind(),this.unbind(),this.remove()},render:function(){return this.$el.html(this.template({post:this.model.toJSON()})),this}}),f=b.Collection.extend({model:d,url:"/api/posts",page:0,parse:function(a,c){return this.page=a.page,b.Collection.prototype.parse.call(this,a.data,c)},fetchMore:function(){this.fetch({data:{page:this.page+1},remove:!1})}}),g=b.View.extend({id:"#posts",_views:[],template:c.template(["<@ if (!length) { @>",'<h3 style="color: #888">Ops! Você não está seguindo tag nenhuma. :/</h3>',"<@ } @>",'<h3 id="posts-desc">Últimas atualizações dos assuntos que você segue...</h3>',"<hr>"].join("\n")),initialize:function(){this.collection.on("reset",this.addAll,this),this.collection.on("add",this.addAll,this)},addAll:function(){var a=[];return this.collection.each(function(b){a.push(new e({model:b}))},this),this._views=a,this.render()},render:function(){var b=document.createDocumentFragment();return c.each(this._views,function(a){b.appendChild(a.render().el)},this),this.$el.empty(),this.$el.append(b),this._views.length?a("#no-posts-msg").hide():a("#no-posts-msg").show(),this},destroy:function(){this.remove()}}),h=b.View.extend({id:"#post",className:"post",template:c.template(a("#template-postview-single").html()),initialize:function(){this.model.on("change",this.render,this)},destroy:function(){this.undelegateEvents(),this.$el.removeData().unbind(),this.unbind(),this.remove()},render:function(){return console.log("render"),this.$el.html(this.template({post:this.model.toJSON()})),this}});return{item:d,list:f,view:e,listView:g,singleView:h}}(),g=b.sync;b.sync=function(a,b,d){if("patch"===a&&d.attrs instanceof Array){for(;e=d.attrs.pop();)d.attrs[e]=b.get(e);d.type="PUT",d.attrs=c.extend({},d.attrs)}return g(a,b,d)},WorkspaceRouter=b.Router.extend({routes:{"posts/:post":"singlePost","*a":"index"},initialize:function(){window.app=this,this.tagList=new d.list,this.tagListView=new d.listView({collection:this.tagList}),a("#tags-wrapper").prepend(this.tagListView.$el),this.tagList.parseAndReset(window._tags)},singlePost:function(a){this.postListView&&this.postListView.destroy(),this.selPostModel=new f.item({id:a}),this.postItemSingleView=new f.singleView({model:this.selPostModel}),this.selPostModel.fetch({reset:!0}),this.postItemSingleView.$el.appendTo("#posts-col > .placement")},index:function(){console.log("index)"),this.postItemSingleView&&this.postItemSingleView.destroy(),this.postList=new f.list,this.postListView=new f.listView({collection:this.postList}),this.postList.fetch({reset:!0}),this.postListView.$el.appendTo("#posts-col > .placement")},confirmTags:function(a){this.tagList.save(a)}}),a(function(){new WorkspaceRouter,b.history.start({pushState:!1}),a("#tags-wrapper [type=submit]").click(function(a){a.stopPropagation(),a.preventDefault(),window.app.confirmTags(function(){location.href="/"})}),a("#posts-col").scroll(function(){a("#posts-col .placement").height()-(a(window).height()+a("#posts-col").scrollTop())<200&&app.postList.fetchMore()})})});