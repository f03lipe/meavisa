/*! meavisa - v0.0.2
* http://meavisa.org
* Copyright (c) 2014 ; Licensed  */
requirejs.config({appDir:".",baseUrl:"static/js",paths:{jquery:["//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min","vendor/jquery-2.0.3.min"],bootstrap:["//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.0.0/js/bootstrap.min","vendor/bootstrap-3.0.0.min"],underscore:["//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.5.1/underscore-min","vendor/underscore-1.5.1.min"],backbone:["//cdnjs.cloudflare.com/ajax/libs/backbone.js/1.0.0/backbone-min","vendor/backbone-1.0.0.min"]},shim:{underscore:{exports:"_"},bootstrap:{deps:["jquery"]},backbone:{exports:"Backbone",deps:["underscore","jquery"]}}}),require(["jquery","bootstrap"],function(a){a("a[data-ajax-post-href],button[data-ajax-post-href]").click(function(){var b=this.dataset.ajaxPostHref,c=this.dataset.redirectHref;console.log(this.dataset,b),a.post(b,function(){c?window.location.href=c:window.location.reload()})}),a("form[data-ajax-post-href]").on("submit",function(b){b.preventDefault();var c=this.dataset.ajaxPostHref+"?"+a(this).serialize();console.log(this.dataset,c),a.post(c,function(){window.location.reload()})}),a(".btn-follow").click(function(){var b=this;switch(this.dataset.action){case"unfollow":a.post("/api/users/"+this.dataset.user+"/unfollow",function(a){a.error?alert(a.error):b.dataset.action="follow"});break;case"follow":a.post("/api/users/"+this.dataset.user+"/follow",function(a){a.error?alert(a.error):b.dataset.action="unfollow"})}}),a(function(){if(a("[data-toggle=popover]").popover(),a("[data-toggle=tooltip]").tooltip(),a("[data-toggle=dialog]").xdialog(),"front"===document.body.dataset.page){var b=a("nav.bar"),c=(a("#jumbo").height(),b.outerHeight());a(window).on("scroll ready",function(){a(window).scrollTop()>c?b.addClass("opaque"):b.removeClass("opaque")})}}),function(){a.ajaxPrefilter(function(b,c,d){b.crossDomain||d.setRequestHeader("X-CSRF-Token",a("meta[name='csrf-token']").attr("content"))})}(),function(b){a(".flash-msgs")[0]||a("<div class='flash-msgs'>").prependTo(a("body > section")[0]);for(var c=0;b.warn&&c<b.warn.length;c++)a("<div class='warn'><button type=button class=close data-dismiss=alert aria-hidden=true>&times;</button>"+b.warn[c]+"</div>").hide().appendTo(a(".flash-msgs")).slideDown();for(var c=0;b.info&&c<b.info.length;c++)a("<div class='info'><button type=button class=close data-dismiss=alert aria-hidden=true>&times;</button>"+b.info[c]+"</div>").hide().appendTo(a(".flash-msgs")).slideDown()}(window._flash_msgs)}),function(){for(var a,b=function(){},c=["assert","clear","count","debug","dir","dirxml","error","exception","group","groupCollapsed","groupEnd","info","log","markTimeline","profile","profileEnd","table","time","timeEnd","timeStamp","trace","warn"],d=c.length,e=window.console=window.console||{};d--;)a=c[d],e[a]||(e[a]=b)}(),require(["jquery"],function(a){"strict use";a.fn.sshare=function(b){if(!this.find(".sn-share-btns").length){var c={trigger:"hover",duration:"fast",text:void 0,url:"http://vempraruavem.org"},b=a.extend(a.extend(c,this.data()),b),d={twitter:function(){if(!b.text&&!b.url)throw"No url or text specified";var a="http://twitter.com/share?"+(b.text&&"&text="+encodeURIComponent(b.text))||"url="+encodeURIComponent(b.url);window.open(a,"","width=500,height=350,toolbar=0,menubar=0,location=0","modal=yes")},facebook:function(){if(!b.url)throw"No url or text specified";var a="http://www.facebook.com/sharer.php?u="+encodeURIComponent(b.url);window.open(a,"","width=500,height=350,toolbar=0,menubar=0,location=0","modal=yes")},gplus:function(){if(!b.url)throw"No url or text specified";var a="https://plusone.google.com/_/+1/confirm?hl=pt&url="+encodeURIComponent(b.url);window.open(a,"","width=500,height=350,toolbar=0,menubar=0,location=0","modal=yes")}};this.addClass("sn-share");var e=a('<div class="sn-share-btns"><div class="btn-group"><button class="btn btn-xs btn-info btn-twitter"><i class="fa fa-twitter"></i></button><button class="btn btn-xs btn-info btn-facebook">&nbsp;<i class="fa fa-facebook"></i>&nbsp;</button><button class="btn btn-xs btn-info btn-gplus"><i class="fa fa-google-plus"></i></button></div><div class="arrow"></div></div>');e.find(".btn-twitter").click(d.twitter),e.find(".btn-facebook").click(d.facebook),e.find(".btn-gplus").click(d.gplus),e.appendTo(this),this.click(function(a){return a.stopPropagation(),a.preventDefault(),!1}),b.now===!0?(e.fadeIn(),this.on("click "+("hover"===b.trigger?"mouseenter":""),function(){e.fadeIn(b.duration)})):this.on("click "+("hover"===b.trigger?"mouseenter":""),function(){e.fadeIn(b.duration)}),this.on("mouseleave",function(){e.fadeOut(b.duration)})}},a.fn.xdialog=function(){if(this[0]){var b=this[0].hash||"#"+this[0].dataset.hash,c=a(b),d=!!this.data("hide-url");this.click(function(a){a.preventDefault(),c.addClass("active"),d||history.pushState({},"",b)}),c.find("[data-action=close-dialog]").click(function(a){a.preventDefault(),c.removeClass("active"),d||(location.hash="")})}}}),require(["jquery","backbone","underscore","bootstrap"],function(a,b,c){c.templateSettings={interpolate:/\<\@\=(.+?)\@\>/gim,evaluate:/\<\@([\s\S]+?)\@\>/gim,escape:/\<\@\-(.+?)\@\>/gim},a('[data-action="send-post"]').click(function(){var b=a("textarea").val();a.ajax({type:"post",url:"/api/posts",data:{content:{body:b}}}).done(function(a){alert("data",a)})});var d=function(){"use strict";var d=b.View.extend({bindDestroyBtn:function(){this.$el.on("click","[data-action=remove-post]",this.destroy.bind(this))},destroy:function(){var a=this;this.model.destroy({success:function(){a.$el.removeData().unbind(),a.remove()}})}}),e=b.Model.extend({}),f=d.extend({tagName:"li",className:"post",template:c.template(a("#template-commentview").html()),initialize:function(){},destroy:function(){this.undelegateEvents(),this.$el.removeData().unbind(),this.unbind(),this.remove()},render:function(){return this.$el.html(this.template({comment:this.model.toJSON()})),this}}),g=b.Collection.extend({model:e,page:0,constructor:function(a){this.postItem=a.postItem,console.log("this.postItem",this.postItem),b.Collection.apply(this,arguments)},url:function(){return this.postItem.get("apiPath")+"/comments"},parse:function(a,c){return this.page=a.page,b.Collection.prototype.parse.call(this,a.data,c)},tryFetchMore:function(){-1!==this.page&&this.fetch({data:{page:this.page+1},remove:!1})}}),h=b.View.extend({tagName:"ul",className:"commentList",_commentViews:[],initialize:function(){this.collection.on("reset",this.addAll,this),this.collection.on("add",this.addAll,this)},addAll:function(){var a=[];return this.collection.each(function(b){a.push(new f({model:b}))},this),this._commentViews=a,this.render()},render:function(){var a=document.createDocumentFragment();return c.each(this._commentViews,function(b){a.appendChild(b.render().el)},this),this.$el.empty(),this.$el.append(a),this},destroy:function(){this.remove()}}),i=b.Model.extend({url:function(){return this.get("apiPath")},initialize:function(){this.commentsList=new g({postItem:this}),this.commentsList.fetch({reset:!0})}}),j=d.extend({tagName:"li",className:"post",template:c.template(a("#template-postview").html()),initialize:function(){this.model.collection.on("reset",this.destroy,this),this.bindDestroyBtn()},events:{"submit .formPostComment":function(b){console.log("this is",this);var c=a(b.target).find("textarea").val();a.ajax({type:"post",url:this.model.get("apiPath")+"/comments",data:{content:{body:c}}}).done(function(a){alert("data",a)})}},render:function(){return this.$el.html(this.template({post:this.model.toJSON()})),this.commentListView=new h({collection:this.model.commentsList}),this.$el.find(".post-comments-section").append(this.commentListView.$el),this}}),k=b.Collection.extend({model:i,url:window.postsRoot||"/api/timeline/posts",page:0,parse:function(a,d){this.page=a.page;var e=b.Collection.prototype.parse.call(this,a.data,d);return c.filter(e,function(a){return!!a})},tryFetchMore:function(){-1!==this.page&&this.fetch({data:{page:this.page+1},remove:!1})}}),l=b.View.extend({id:"#posts",_postViews:[],template:c.template(["<@ if (!length) { @>",'<h3 style="color: #888">Nenhum post visível. :/</h3>',"<@ } @>",'<h3 id="posts-desc">Últimas atualizações dos assuntos que você segue...</h3>',"<hr>"].join("\n")),initialize:function(){this.collection.on("reset",this.addAll,this),this.collection.on("add",this.addAll,this)},addAll:function(){var a=[];return this.collection.each(function(b){a.push(new j({model:b}))},this),this._postViews=a,this.render()},render:function(){var b=document.createDocumentFragment();return c.each(this._postViews,function(a){b.appendChild(a.render().el)},this),this.$el.empty(),this.$el.append(b),this._postViews.length?a("#no-posts-msg").hide():a("#no-posts-msg").show(),this},destroy:function(){this.remove()}});return{item:i,list:k,view:j,listView:l}}(),f=b.sync;b.sync=function(a,b,d){if("patch"===a&&d.attrs instanceof Array){for(;e=d.attrs.pop();)d.attrs[e]=b.get(e);d.type="PUT",d.attrs=c.extend({},d.attrs)}return f(a,b,d)},WorkspaceRouter=b.Router.extend({routes:{"*a":"index"},initialize:function(){window.app=this},index:function(){console.log("index"),this.postList=new d.list,this.postListView=new d.listView({collection:this.postList}),this.postList.fetch({reset:!0}),this.postListView.$el.appendTo("#posts-col > .placement")}}),a(function(){new WorkspaceRouter,b.history.start({pushState:!1}),a("#globalContainer").scroll(c.throttle(function(){a("#posts-col .placement").height()-(a(window).height()+a("#posts-col").scrollTop())<200&&app.postList.tryFetchMore()},500))})});