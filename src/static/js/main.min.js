require(["jquery","backbone","underscore","bootstrap"],function(a,b,c){var d=function(){"use strict";var d=b.Model.extend({idAttribute:"hashtag",saveOnChange:!1,defaults:{children:[],description:null},initialize:function(){this.children=new f,this.collection.on("reset",this.loadChildren,this),this.collection.on("checkAll",this.check,this),this.collection.on("uncheckAll",this.uncheck,this)},toggleChecked:function(a){var b=this.get("checked");if(b&&"false"!==b?this.set({checked:!1}):this.set({checked:!0}),a&&void 0!==a.save?a.save===!0:this.saveOnChange){var c=a&&a.callback||function(){};this.save(["checked"],{patch:!0,success:c,error:c})}},check:function(a){if(this.set({checked:!0}),a&&void 0!==a.save?a.save===!0:this.saveOnChange){var b=a&&a.callback||function(){};this.save(["checked"],{patch:!0,success:b,error:b})}},uncheck:function(a){if(this.set({checked:!1}),a&&void 0!==a.save?a.save===!0:this.saveOnChange){var b=a&&a.callback||function(){};this.save(["checked"],{patch:!0,success:b,error:b})}},hasCheckedChild:function(){return this.children.length?!c.all(this.children.map(function(a){return!a.get("checked")})):!1},loadChildren:function(){this.children.parseAndReset(this.get("children"))}}),e=b.View.extend({tagName:"li",initialize:function(){this.model.collection.on("reset",this.destroy,this),this.hideChildren=!0,this.childrenView=new h({collection:this.model.children,className:"children"}),this.model.children.on("change",this.childrenChanged,this)},childrenChanged:function(){this.collection!==app.tagList&&this.render()},destroy:function(){console.log('Removing me view ="(',this),this.remove()},render:function(){return g.get("/api/tags/template",function(a,b){this.childrenView.$el.detach(),this.$el.html(c.template(b,{tag:c.extend(this.model.toJSON(),{hasCheckedChild:this.model.hasCheckedChild()})})),this.hideChildren&&this.childrenView.$el.hide(),this.$el.append(this.childrenView.el),this.$("> .tag .info").popover({content:this.model.get("description"),placement:"bottom",trigger:"hover",container:"body",delay:{show:100,hide:300},title:"<i class='icon-tag'></i> "+this.model.get("hashtag"),html:!0}),this.$("> .tag .info").click(function(a){a.stopPropagation()})},this),this},events:{"click >.tag":"tgChecked","click >.expand":"tgShowChildren"},tgChecked:function(a){a.preventDefault(),this.model.get("checked")?this.model.children.trigger("uncheckAll"):this.model.children.trigger("checkAll"),this.model.children.trigger("render"),this.model.toggleChecked(),this.render()},tgShowChildren:function(a){a.preventDefault(),this.hideChildren=!this.hideChildren,this.$(">.expand i").toggleClass("icon-angle-down"),this.$(">.expand i").toggleClass("icon-angle-up"),this.childrenView.$el.toggle(),this.childrenView.render()}}),f=b.Collection.extend({model:d,url:"/api/tags",parse:function(a){return c.toArray(a)},parseAndReset:function(a){this.reset(c.toArray(a))},save:function(b){a.post(this.url,{checked:this.getCheckedTags()},b)},getChecked:function(){var a=this.chain().map(function b(a){return[a].concat(a.children.length?a.children.map(b):[])}).flatten().value();return a.filter(function(a){return a.get("checked")===!0})},getCheckedTags:function(){return this.getChecked().map(function(a){return a.get("hashtag")})}}),h=b.View.extend({tagName:"ul",_views:[],initialize:function(){this.collection.on("render",this.render,this),this.collection.on("reset",this.addAll,this)},addAll:function(){return this._views=[],this.collection.each(function(a){this._views.push(new e({model:a}))},this),this.render()},render:function(){var a=document.createDocumentFragment();return c.each(this._views,function(b){a.appendChild(b.render().el)},this),this.$el.empty(),this.$el.append(a),this}});return{item:d,list:f,view:e,listView:h}}(),f=function(){"use strict";var d=b.Model.extend({}),e=b.View.extend({tagName:"li",initialize:function(){this.model.collection.on("reset",this.destroy,this)},destroy:function(){this.remove()},render:function(){return g.get("/api/posts/template",function(a,b){this.$el.html(c.template(b,{post:this.model.toJSON()}))},this),this}}),f=b.Collection.extend({model:d,url:"/api/posts"}),h=b.View.extend({el:"#posts > ul",_views:[],template:c.template(["<% if (!length) { %>",'<h3 style="color: #888">Ops! Você não está seguindo tag nenhuma. :/</h3>',"<% } %>","<hr>"].join("\n")),initialize:function(){this.collection.on("reset",this.addAll,this)},addAll:function(){var a=[];return this.collection.each(function(b){a.push(new e({model:b}))},this),this._views=a,this.render()},render:function(){var b=document.createDocumentFragment();return c.each(this._views,function(a){b.appendChild(a.render().el)},this),this.$el.empty(),this.$el.append(b),this._views.length?a("#no-posts-msg").hide():a("#no-posts-msg").show(),this}});return{item:d,list:f,view:e,listView:h}}(),g={get:function(b,c,d){var e=this.templates[b];if(e)c.call(d,null,e);else{var f=this;a.get(b,function(a){f.templates[b]=a,c.call(d,null,a)})}},templates:{}},h=b.sync;b.sync=function(a,b,d){if("patch"===a&&d.attrs instanceof Array){for(;e=d.attrs.pop();)d.attrs[e]=b.get(e);d.type="PUT",d.attrs=c.extend({},d.attrs)}return h(a,b,d)},app=new(b.Router.extend({initialize:function(){},initPreview:function(){a("#btn-preview").prop("disabled",!0),a(document).on("click",".tag",function(){console.log("hey, I was called"),a("#btn-preview").prop("disabled",!1)})},start:function(){b.history.start({pushState:!1}),this.tagList=new d.list,this.tagListView=new d.listView({collection:this.tagList}),a("#tags").prepend(this.tagListView.$el),this.tagList.parseAndReset(window._tags),this.initPreview(),this.postList=new f.list,this.postListView=new f.listView({collection:this.postList}),this.postList.reset(window._posts)},previewPosts:function(){this.initPreview();var b=app.tagList.getCheckedTags().join(",")||",";this.postList.fetch({data:{tags:b},processData:!0,reset:!0}),a("#posts-desc").html("Esses são os assuntos que vão aparecer para você:")},confirmTags:function(a){this.tagList.save(a)},routes:{"":"index"},index:function(){}})),a(function(){a("#tags [type=submit]").click(function(a){a.stopPropagation(),a.preventDefault(),window.app.confirmTags(function(){location.href="/"})}),a("#btn-preview").click(function(a){a.stopPropagation(),a.preventDefault(),window.app.previewPosts()}),app.start()}),function(){jQuery.ajaxPrefilter(function(b,c,d){d.crossDomain||d.setRequestHeader("X-CSRF-Token",a("meta[name='csrf-token']").attr("content"))})}()});