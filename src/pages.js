// Generated by CoffeeScript 1.6.3
(function() {
  var User, api, blog, blog_url, e, env, getPostsWithTags, posts, request, sendNotification, topics, _;

  _ = require('underscore');

  api = require('./apis.js');

  request = require('request');

  try {
    env = require('./env.js');
  } catch (_error) {
    e = _error;
    env = {
      facebook: {
        app_id: process.env.facebook_app_id,
        secret: process.env.facebook_secret,
        canvas: process.env.facebook_canvas
      }
    };
  }

  blog_url = 'http://meavisa.tumblr.com';

  blog = api.getBlog("meavisa.tumblr.com");

  topics = [];

  posts = [];

  blog.posts(function(err, data) {
    if (err) {
      throw err;
    }
    return data.posts.forEach(function(post, i) {
      return post.tags.forEach(function(tag) {
        if (topics.indexOf(tag) === -1) {
          topics.push(tag);
          return console.log('pushing found tag', tag);
        }
      });
    });
  });

  sendNotification = function(user_id, template, callback) {
    var access_token, url;
    access_token = '521238787943358|irzJJKJ0-Z8-LiUshAfFazAirac';
    url = "https://graph.facebook.com/" + user_id + "/notifications?access_token=" + access_token + "&template=" + template;
    return request.post(url, function(error, response, body) {
      console.log('request with given token:', body, error, url);
      if (callback) {
        return callback(error, response, body);
      }
    });
  };

  getPostsWithTags = function(tags, callback) {
    return blog.posts({
      limit: -1
    }, function(err, data) {
      posts = [];
      data.posts.forEach(function(post) {
        var int;
        int = _.intersection(post.tags, tags);
        if (int[0]) {
          return posts.push(post);
        }
      });
      return callback(posts);
    });
  };

  User = require('./app/models/user.js');

  exports.Pages = {
    index: {
      get: function(req, res) {
        if (req.user) {
          req.session.messages = [JSON.stringify(req.user)];
          getPostsWithTags(req.user.tags, function() {
            return res.render('panel', {
              user: req.user,
              topics: topics,
              posts: posts,
              blog_url: blog_url,
              messages: [JSON.stringify(req.user), JSON.stringify(req.session)]
            });
          });
          return;
        }
        if (req.ip === '127.0.0.1') {
          res.writeHead(200, {
            'Content-Type': 'text/html;charset=UTF-8'
          });
          res.end("" + User.findOrCreate + "s" + req.ip + "<br><form method='get' action='/auth/facebook'><input type='submit' name='oi' value='post'></form>");
          return;
        }
        return User.find({}, function(err, users) {
          res.writeHead(200, {
            'Content-Type': 'text/html;charset=UTF-8'
          });
          res.write(JSON.stringify(users));
          return res.end('\noi, ' + req.ip + JSON.stringify(req.session) + "<form method='get' action='/auth/facebook'><input type='submit' name='oi' value='post'></form>");
        });
      },
      post: function(req, res) {
        return res.redirect('/auth/facebook');
      }
    },
    logout: {
      get: function(req, res) {
        req.logout();
        return res.redirect('/');
      }
    },
    session: {
      get: function(req, res) {
        return User.find({}, function(err, users) {
          res.write(JSON.stringify(users));
          return res.end('\noi, ' + req.ip + JSON.stringify(req.session));
        });
      }
    },
    update: {
      get: function(req, res) {
        var chosen, topic, _i, _len, _ref;
        if (!req.user) {
          return res.redirect('/');
        }
        if (!req.query['topic'] || typeof req.query['topic'] === 'string') {
          req.query['topic'] = [req.query['topic']];
        }
        chosen = [];
        _ref = req.query['topic'];
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          topic = _ref[_i];
          if (topic) {
            chosen.push(topic);
          }
        }
        console.log('chosen: ', chosen, req.query['topic']);
        req.user.tags = chosen;
        req.user.save();
        sendNotification(req.user.facebookId, 'You are now following the topics #{chosen} on MeAvisa.');
        getPostsWithTags(chosen, function() {});
        return res.redirect('back');
      }
    },
    dropall: {
      get: function(req, res) {
        return User.remove({}, function(err) {
          res.write("collection removed");
          return res.end(err);
        });
      }
    }
  };

}).call(this);
